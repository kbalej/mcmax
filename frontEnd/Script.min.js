var userid="",usrname="",usraccess="",h=localStorage.getItem("userid"),h1=localStorage.getItem("usrname"),h2=localStorage.getItem("usraccess");null==h2&&(h2=""),void 0!==h&&""!==h&&(userid=h,usrname=h1,usraccess=h2);var mmApp=angular.module("mmApp",["ngSanitize"]);mmApp.controller("mmCtrl",function($scope,$timeout,$http,$sce){var dummy="//$scope.x_o//";for(var x in $scope.x_o.lookups)null==$scope.x_o.lookups[x].masterLookup||null==$scope.x_o.lookups[x].masterLookup||""==$scope.x_o.lookups[x].masterLookup?$scope.x_o.lookups[x].load=function(){$http.post(sloc+"KB_x_getAll?module="+$scope.x_o.name+"&table="+this.getParameters+"&masterID=&orderBy=name&rowsPage=999999&pageCt=1",JSON.stringify({params:[],sql:""})).then(function(e){$scope.x_o.lookups[e.data.table].collection=e.data.rv,$scope.x_o.lookups[e.data.table].tree=convertListTree(e.data.rv),$scope.x_o.lookups[e.data.table].tree1=$scope.x_o.lookups[e.data.table].tree.filter(function(e){return e.show})},function(e){alert(JSON.stringify(e))})}:$scope.x_o.lookups[x].load=function(){$http.post(sloc+"KB_x_getAll?module="+$scope.x_o.name+"&table="+this.getParameters+"&masterID="+this.masterID+"&orderBy=name&rowsPage=999999&pageCt=1",JSON.stringify({params:[],sql:""})).then(function(e){$scope.x_o.lookups[e.data.table].collection=e.data.rv,$scope.x_o.lookups[e.data.table].tree=convertListTree(e.data.rv),$scope.x_o.lookups[e.data.table].tree1=$scope.x_o.lookups[e.data.table].tree.filter(function(e){return e.show})},function(e){$scope.x_o.lookups[e.data.table].collection=null,$scope.x_o.lookups[e.data.table].tree=null,$scope.x_o.lookups[e.data.table].tree1=null})};for(var x in $scope.xMessages=[],$scope.SelMessaging="system",$scope.messageFor="",$scope.messageBody="",$scope.x_form=" ",$scope.x_page=" ",$scope.mainForms=[],$scope.x_o.forms)(null==$scope.x_o.forms[x].parent||""==$scope.x_o.forms[x].parent&&$scope.x_o.forms[x]._R)&&$scope.mainForms.push($scope.x_o.forms[x]);if($scope.SelMod=$scope.x_o.name,$scope.SelLevel="",$scope.SelRole="",$scope.AvailableModules=$scope.x_o.dbs,$scope.AvailableModules[0]={name:"refresh"},$scope.AvailableLevels=["KB","Administrator","Superuser","User","Guest"],$scope.x_n=[],$scope.xElement={},$scope.topName="",$scope.ieElement={},$scope.ieeditingInProgress=!1,$scope.error="",$scope.login={usrname:"",password:""},$scope.xSearch={},$scope.xSearchListTitle="",$scope.xSearchSql={},$scope.xSearchSql.params=[],$scope.xSearchSql.sql="",$scope.socket=io(),$scope.socket.on("system",function(e){if("system"==$scope.SelMessaging){var o={},s=new Date;for(o.time=s.getHours()+":"+s.getMinutes(),o.from="system",o.to="all",o.message=e,$scope.xMessages.unshift(o);$scope.xMessages.length>20;)$scope.xMessages.pop()}}),$scope.socket.on("user",function(e){var o=JSON.parse(e);if("private"==$scope.SelMessaging&&o.to==usrname)for($scope.xMessages.unshift(o);$scope.xMessages.length>20;)$scope.xMessages.pop();if("all"==$scope.SelMessaging)for($scope.xMessages.unshift(o);$scope.xMessages.length>20;)$scope.xMessages.pop()}),$http.post(sloc+"KB_getStats","").then(function(response){var h="["+response.data+"]",h1=eval(h);$scope.data1=h1[0],$scope.data2=h1[1];for(var years1=[],i=0;i<$scope.data1.length;i++){Element=$scope.data1[i];var year={label:Element.nYear.substring(8,10),y:Element.Tnet};years1.push(year)}str=JSON.stringify(years1);var ress1=str.replace(/"/g,"");ress1=ress1.replace(/label:/g,'label: "'),ress1=ress1.replace(/,y:/g,'", y: ');for(var services=[],i=0;i<$scope.data2.length;i++){Element=$scope.data2[i];var s={label:Element.Service,y:Element.Tnet};services.push(s)}str=JSON.stringify(services);var ress2=str.replace(/"/g,"");ress2=ress2.replace(/label:/g,'label: "'),ress2=ress2.replace(/,y:/g,'", y: '),$scope.chart1=new CanvasJS.Chart("chartContainer1",{title:{text:"logins"},data:[{type:"splineArea",dataPoints:eval(ress1)}]}),$scope.chart1.render(),$scope.chart2=new CanvasJS.Chart("chartContainer2",{title:{text:"top 10"},data:[{type:"doughnut",dataPoints:eval(ress2)}]}),$scope.chart2.render()},function(e){alert("get stats error")}),void 0!==userid&&""!==userid&&null!==userid){var searchParameters=[],o={field:"ID",compare:"EQUAL"};o.value=userid,searchParameters.push(o),$scope.xSearchSql={},$scope.xSearchSql.params=searchParameters,$scope.xSearchSql.sql="ID = '"+userid+"'",$scope.login.usrname=usrname,$http.post(sloc+"KB_x_getAll?module=KB&table=users&jsonFields=&orderBy=name&masterID=%&rowsPage=1&pageCt=1",JSON.stringify($scope.xSearchSql)).then(function(e){e.data.rv.length>0?($scope.myData=e.data.rv[0],userid=e.data.rv[0].ID,usrname=e.data.rv[0].infoJSON.name,usraccess=e.data.rv[0].infoJSON.access,setAccessRights()&&($scope.error="",$scope.x_page=" ")):($scope.error=">> user unknown <<",userid="",$scope.login={usrname:"",password:""},$scope.x_page="LOGIN")},function(e){$scope.error=">> system error <<",userid="",$scope.login={usrname:"",password:""},$scope.x_page="LOGIN"})}else $scope.x_page="LOGIN";$scope.messageSend=function(){if(""!==$scope.messageBody){var e={},o=new Date;e.time=o.getHours()+":"+o.getMinutes(),e.from=usrname,e.to=$scope.messageFor,e.message=$scope.messageBody,$http.post(sloc+"KB_sendMessage?module=KB",JSON.stringify(e)).then(function(e){$scope.messageFor="",$scope.messageBody=""},function(e){alert("send message error")})}},$scope.changeModule=function(){"refresh"==$scope.SelMod&&($scope.SelMod=$scope.x_o.name),window.open(sloc+"HTML.html?module="+$scope.SelMod,"_self",!1)},$scope.x_n.length>0?null==$scope.x_n[$scope.x_n.length-1].xElement.name?$scope.topName="details "+$scope.x_form:$scope.topName=$scope.x_n[$scope.x_n.length-1].xElement.name+" "+$scope.x_form:$scope.topName=$scope.x_form,$scope.x_rowsPage=20,$scope.x_rowsMax=1,$scope.x_pageCt=1;var ca=$scope.x_o.columns,c={};for(var lu in $scope.x_o.lookups)null!=$scope.x_o.lookups[lu].masterLookup&&null!=$scope.x_o.lookups[lu].masterLookup||$scope.x_o.lookups[lu].load();$scope.mymenu=function(e){"quit"===e&&(localStorage.removeItem("userid"),localStorage.removeItem("usrname"),localStorage.removeItem("usraccess"),window.close()),"mydata"===e&&($scope.x_form="mydata",$scope.x_page="EDIT",$scope.xElement=$scope.myData)},$scope.select=function(e,o){selectListTree(e,$scope.x_o.lookups[o].tree)&&($scope.x_o.lookups[o].tree1=null,$scope.x_o.lookups[o].tree1=$scope.x_o.lookups[o].tree.filter(function(e){return e.show}))},treeUpdate=function(){var e=""+$scope.x_o.forms[$scope.x_form].fieldsLookup;if(""!==e){var o=e.split(",");if(o.length>0)for(var s in o){var t="";void 0!==$scope.xElement.infoJSON[o[s]]&&(t=$scope.xElement.infoJSON[o[s]]);var r=o[s].substring(0,o[s].length-2),c=$scope.x_o.lookups[r].tree;for(var n in c)c[n].level>0&&(c[n].ID===t?c[n].show=!0:c[n].show=!1);$scope.x_o.lookups[r].tree1=null,void 0!==$scope.x_o.lookups[r].tree&&($scope.x_o.lookups[r].tree1=$scope.x_o.lookups[r].tree.filter(function(e){return e.show}))}}},$scope.spacesListTree=function(e){var o,s="";for(o=0;o<e;o++)s+="....";return s},convertListTree1=function(e,o,s,t){if(e+=1,""==o)r=s.filter(function(e){return""==e.parentID});else var r=s.filter(function(e){return e.parentID.includes(o)});for(var c in r){var n={};n.ID=r[c].ID,n.show=0==e,n.level=e,n.name=r[c].infoJSON.name,n.parentID=r[c].parentID,n.sel=!1,t.push(n),convertListTree1(e,r[c].ID,s,t)}},convertListTree=function(e){var o=[];return convertListTree1(-1,"",e,o),o},selectListTree=function(e,o){var s=0;for(var t in o)o[t].parentID==e&&(s+=1);if(s<1)return!1;var r=!0;for(var t in o)o[t].sel=!1,o[t].level>0&&(o[t].show=!1,o[t].parentID==e&&(o[t].show=!0,r&&(r=!1,o[t].sel=!0)));return!0},removeString=function(e){var o=e;try{o.includes("STRING:")&&(o=o.substring(7))}catch(e){o=void 0}return o},removeTrailingComma=function(e){var o="";return e.length>0&&(o=e.substring(0,e.length-1)),o},$scope.orderByMe=function(e){if(void 0===$scope.myOrderBy){var o=e.replace("ID","Name");$scope.myOrderBy="infoJSON."+o}else $scope.myOrderBy=void 0},initMap=function(e){new google.maps.Geocoder;var o=new google.maps.Map(document.getElementById("Googlemap"),{center:{lat:46.07869193484069,lng:7.215027570724487},mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:16}),s=new google.maps.Marker({position:new google.maps.LatLng(46.07869193484069,7.215027570724487),title:"x",map:o,draggable:!0});google.maps.event.addListener(s,"dragend",function(){var o=s.getPosition();$scope.xElement.infoJSON[e+"Latitude"]=o.lat(),$scope.xElement.infoJSON[e+"Longitude"]=o.lng()})},removePicture=function(e){$scope.xElement.infoJSON[e]="smily.jpg",$scope.xElement.infoJSON[e+"Path"]=floc+$scope.xElement.infoJSON[e]},changePicture=function(e,o){var s=new FormData,t=$("#"+e).get(0).files;if(!(t.length>0))return alert("No file selected !"),!1;if(t[0].size/1e3>1e4)return alert("Max File size is 10 MB !"),!1;s.append("UploadedImage",t[0]);$.ajax({type:"POST",url:sloc+"upload",contentType:!1,processData:!1,data:s,success:function(e){return $scope.xElement.infoJSON[o]=e,$scope.xElement.infoJSON[o+"Path"]=floc+$scope.xElement.infoJSON[o],$scope.xSave(),!0},error:function(e,o,s){return alert("File upload error: "+o),!1}})},$scope.completeLookupField=function(buffer,item,lookupFields){var ij=".infoJSON.";"xSearch"==buffer&&(ij=".");var t_p=eval("$scope."+buffer+ij+item+"ID"),t_c=$scope.x_o.lookups[item].collection,t_e=t_c.filter(function(e){return e.ID==t_p});if(eval("$scope."+buffer+ij+item+"Name = t_e[0].infoJSON.name"),void 0!==typeof $scope.x_o.lookups[item].masterLookup&&(eval("$scope."+buffer+ij+item+"masterID = $scope.x_o.lookups."+item+".masterID"),eval("$scope."+buffer+ij+item+"masterName = $scope.x_o.lookups."+item+".masterName")),void 0!==lookupFields&&""!==lookupFields)for(var result=lookupFields.match(/\w+/g),i=0;i<result.length;i+=2)eval("$scope."+buffer+ij+result[i+1]+" = t_e[0].infoJSON."+result[i]);for(var x in $scope.x_o.lookups)$scope.x_o.lookups[x].masterLookup===item&&$scope.x_o.lookups[x].masterID!==t_p&&($scope.x_o.lookups[x].masterID=t_p,$scope.x_o.lookups[x].masterName=t_e.infoJSON.name,$scope.x_o.lookups[x].load())},$scope.getDescription=function(e){return $scope.x_o.forms[e].description},initLookups=function(){var e,o=(""+$scope.x_o.forms[$scope.x_form].fieldsLookup).split(",");if(null!=o[0]&&""!=o[0]){for(e in $scope.x_o.lookups)void 0!==$scope.x_o.lookups[e].masterLookup&&$scope.x_o.lookups[e].masterLookup==$scope.x_o.forms[$scope.x_form].tablesName&&($scope.x_o.lookups[e].masterID=$scope.xElement.ID,$scope.x_o.lookups[e].load());for(e in $scope.x_o.lookups)for(var s in o)void 0!==$scope.xElement.infoJSON[o[s]]&&void 0!==$scope.x_o.lookups[e].masterLookup&&$scope.x_o.lookups[e].masterLookup==o[s].substring(0,o[s].length-2)&&($scope.x_o.lookups[e].masterID=$scope.xElement.infoJSON[o[s]],$scope.x_o.lookups[e].load());for(var t in o){var r=o[t].substring(0,o[t].length-2);if(void 0!==$scope.xElement.infoJSON[o[t]]&&void 0!==$scope.x_o.lookups[r]&&void 0!==$scope.x_o.lookups[r].masterLookup&&null!==$scope.x_o.lookups[r].masterLookup)for(e in $scope.x_o.lookups[r].masterID!==$scope.xElement.infoJSON[r+"masterID"]&&($scope.xElement.infoJSON[r+"ID"]=null,$scope.xElement.infoJSON[r+"Name"]=null,$scope.xElement.infoJSON[r+"masterID"]=null,$scope.xElement.infoJSON[r+"masterName"]=null),$scope.x_o.lookups)$scope.x_o.lookups[e].masterLookup===r&&void 0!==$scope.xElement.infoJSON[$scope.x_o.lookups[e].name+"masterID"]&&$scope.x_o.lookups[e].masterID!==$scope.xElement.infoJSON[$scope.x_o.lookups[e].name+"masterID"]&&($scope.x_o.lookups[e].masterID=removeString($scope.xElement.infoJSON[$scope.x_o.lookups[e].name+"masterID"]),$scope.x_o.lookups[e].masterName=$scope.xElement.infoJSON[$scope.x_o.lookups[e].name+"masterName"],$scope.x_o.lookups[e].load())}}},$scope.ieeditSwitch=function(e){$scope.ieeditingInProgress=!$scope.ieeditingInProgress,$scope.ieeditingInProgress?$scope.ieElement=e:$scope.ieElement={}},$scope.iedelete=function(e){$scope.ieeditingInProgress=!1,$scope.xDelete(e)},$scope.ieupdate=function(e){$scope.xElement=$scope.ieElement,$scope.xElement._edit=null,$scope.xSave(e)},setDefaults=function(){for(var e in $scope.x_o.forms[$scope.x_form].pages)if("EDIT"===e.substring(0,4))for(var o in $scope.x_o.forms[$scope.x_form].pages[e].fields)if(void 0!==$scope.x_o.forms[$scope.x_form].pages[e].fields[o]&&null!==$scope.x_o.forms[$scope.x_form].pages[e].fields[o]&&void 0!==(c=ca[$scope.x_o.forms[$scope.x_form].pages[e].fields[o].columnsID])&&void 0!==c.label&&void 0!==c.default)if("date"===c.fieldType||"datetime"===c.fieldType||"local"===c.fieldType||"month"===c.fieldType||"time"===c.fieldType||"week"===c.fieldType){var s=new RegExp("today").test(c.default),t=parseInt(c.default);if(s){var r=new Date;isNaN(t)||r.setDate(r.getDate()+t),$scope.xElement.infoJSON[c.name]=r,$scope.xEditFormDirty=!0}else $scope.xElement.infoJSON[c.name]=new Date(c.default),$scope.xEditFormDirty=!0}else{if("lookup"===c.fieldType&&"table"===c.source){var n=$scope.x_o.lookups[c.lookup].collection.filter(function(e){return e.infoJSON.name==c.default});n.length>0&&($scope.xElement.infoJSON[c.name.substring(0,c.name.length-2)+"Name"]=c.default,$scope.xElement.infoJSON[c.name]=n[0].ID)}else $scope.xElement.infoJSON[c.name]=c.default;$scope.xEditFormDirty=!0}},validateElement=function(e,flag){var vok=!0,t_val={},res,patt,p,fi,x,t,c,mess=[];for(p in $scope.x_o.forms[$scope.x_form].pages)if("EDIT"===p.substring(0,4))for(fi in $scope.x_o.forms[$scope.x_form].pages[p].fields)null!=fi?void 0!==$scope.x_o.forms[$scope.x_form].pages[p].fields[fi]&&null!==$scope.x_o.forms[$scope.x_form].pages[p].fields[fi]?(c=ca[$scope.x_o.forms[$scope.x_form].pages[p].fields[fi].columnsID],void 0!==c&&void 0!==typeof c.label&&(void 0===t_val[c.name]?($scope.x_o.forms[$scope.x_form].pages[p].fields[fi].validation="form-control",t_val[c.name]={},t_val[c.name].name=c.name,t_val[c.name].html=[],t_val[c.name].html.push(p+" "+fi),void 0!==c.required&&(t_val[c.name].required=c.required.replace(/_/gi,"$scope.xElement.infoJSON.").replace(/::/gi,"'")),void 0!==c.pattern&&(t_val[c.name].regex=c.pattern),void 0!==c.excluded&&(t_val[c.name].excluded=c.excluded),"number"===c.fieldType&&(t_val[c.name].number=!0)):t_val[c.name].html.push(p+" "+fi))):alert("bad "+$scope.x_form+" "+p+" "+fi):alert("bad fi");if(flag){var t_c=$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].columns;for(var c in t_c)void 0!==$scope.x_o.columns[t_c[c]].calcNumber&&$scope.x_o.columns[t_c[c]].calcNumber&&void 0!==eval("document.getElementById('"+$scope.x_o.forms[$scope.x_form].name+$scope.x_o.columns[t_c[c]].name+"').value")&&eval("$scope.xElement.infoJSON[$scope.x_o.columns[t_c[c]].name] = document.getElementById('"+$scope.x_o.forms[$scope.x_form].name+$scope.x_o.columns[t_c[c]].name+"').value");for(x in e)void 0!==t_val[x]&&(t_val[x].value=e[x]);for(t in t_val)if(void 0===t_val[t].value){if(void 0!==t_val[t].required)try{res=eval(t_val[t].required)}catch(e){res=!1}finally{res&&(t_val[t].status=!1,mess.push(t_val[t].name+": required"))}}else void 0!==t_val[t].regex&&(patt=new RegExp("["+t_val[t].regex+"]","g"),res=patt.test(t_val[t].value),res||(t_val[t].status=!1,mess.push(t_val[t].name+": regex pattern"))),void 0!==t_val[t].excluded&&(patt=new RegExp("["+t_val[t].excluded+"]","g"),res=patt.test(t_val[t].value),res&&(t_val[t].status=!1,mess.push(t_val[t].name+": excluded characters"))),void 0!==t_val[t].number&&isNaN(t_val[t].value)&&(t_val[t].status=!1,mess.push(t_val[t].name+": not numeric"));for(t in t_val)if(void 0!==t_val[t].status)for(x in t_val[t].html)patt=/\w+/g,res=t_val[t].html[x].match(patt),$scope.x_o.forms[$scope.x_form].pages[res[0]].fields[res[1]].validation="form-control fieldError",vok=!1;return t_val=void 0,vok||alert(mess),vok}},$scope.log_in=function(){var e=[],o={field:"un",compare:"EQUAL"};o.value=$scope.login.username,e.push(o),(o={}).field="pwd",o.compare="EQUAL",o.value=$scope.login.password,e.push(o);var s={};s.params=e,s.sql="JSON_VALUE(infoJSON,'$.un') = '"+$scope.login.usrname+"' and JSON_VALUE(infoJSON,'$.pwd') = '"+$scope.login.password+"'",$http.post(sloc+"KB_x_getAll?module=KB&table=users&jsonFields=&orderBy=name&masterID=%&rowsPage=1&pageCt=1",JSON.stringify(s)).then(function(e){if(e.data.rv.length>0)if(userid=e.data.rv[0].ID,usrname=e.data.rv[0].infoJSON.name,usraccess=e.data.rv[0].infoJSON.access,localStorage.setItem("userid",userid),localStorage.setItem("usrname",usrname),localStorage.setItem("usraccess",usraccess),$scope.myData=e.data.rv[0],setAccessRights()){var o={};o.date=new Date,$http.post(sloc+"KB_x_addUpdate?module=KB&table=logins&ID=&masterID="+userid+"&orderBy=date&parentID=&sequence=0&uid="+userid,JSON.stringify(o)).then(function(e){$scope.error="",$scope.x_page=" "},function(e){alert("login save error")})}else $scope.error=">> no access rights <<";else $scope.error=">> user name / password unknown <<"},function(e){$scope.error=">> e r r o r <<"})},setAccessRights=function(){var e=!1,o=!1,s="",t="",r={},c=usraccess.split(" ");for(var n in c){var a=c[n].split(":");if("KB"===a[0])e=!0,o=!0,$scope.SelLevel="KB";else if(a[0]!==$scope.x_o.name||"Administrator"!==a[0]&&"Superuser"!==a[0]||(o=!0),a[0]===$scope.x_o.name){var p={};p.name=a[0],r[c[0]]=p,s=t2[0],t=t2[1],$scope.SelLevel=s,$scope.SelRole=t}}if($scope.AvailableModules=e?$scope.x_o.dbs:r,$scope.AvailableModules[0]={name:"refresh"},o)for(var n in $scope.x_o.forms)$scope.x_o.forms[n]._C=!0,$scope.x_o.forms[n]._R=!0,$scope.x_o.forms[n]._U=!0,$scope.x_o.forms[n]._D=!0;else{if(""==s)return!1;if("Guest"==s)for(var n in $scope.x_o.forms)$scope.x_o.forms[n]._C=!1,$scope.x_o.forms[n]._R=!0,$scope.x_o.forms[n]._U=!1,$scope.x_o.forms[n]._D=!1;else{for(var n in $scope.x_o.forms)$scope.x_o.forms[n]._C=!1,$scope.x_o.forms[n]._R=!1,$scope.x_o.forms[n]._U=!1,$scope.x_o.forms[n]._D=!1;var l=[],i={field:"modulesID",compare:"EQUAL"};i.value=$scope.x_o.ID,l.push(i);var m={};m.params=l,m.sql="JSON_VALUE(infoJSON,'$.modulesID') = '"+$scope.x_o.ID+"'",$http.post(sloc+"KB_x_getAll?module=KB&table=accessRights&jsonFields=&orderBy=sequence&masterID=%&rowsPage=900&pageCt=1",JSON.stringify(m)).then(function(e){var o=e.data.rv;for(var s in o){var r=!0;if(""!==t&&(void 0===o[s].roles||null===o[s].roles||""===o[s].roles?r=!1:o[s].roles.includes(t)||(r=!1)),r)for(var c in $scope.x_o.forms[$scope.xList[s].formsName]._C=o[s].create,$scope.x_o.forms[$scope.xList[s].formsName]._R=o[s].read,$scope.x_o.forms[$scope.xList[s].formsName]._U=o[s].update,$scope.x_o.forms[$scope.xList[s].formsName]._D=o[s].delete,$scope.x_o.forms)$scope.x_o.forms[c].ID===$scope.x_o.forms[$scope.xList[s].formsName].parentID&&void 0!==$scope.x_o.forms[c].parentID&&""!==$scope.x_o.forms[c].parentID&&setReadRights($scope.x_o.forms[c].name)}},function(e){return alert("error setAccessRights "+JSON.stringify(e)),!1})}}return!0},$scope.modifyAccessRights=function(){if("KB"!=$scope.SelLevel&&"Administrator"!=$scope.SelLevel&&"Superuser"!=$scope.SelLevel||($scope.SelRole=""),"KB"!==$scope.SelLevel&&"Administrator"!==$scope.SelLevel&&"Superuser"!==$scope.SelLevelel){if(""==$scope.SelLevell)return!1;if("Guest"==$scope.SelLevel)for(var e in $scope.x_o.forms)$scope.x_o.forms[e]._C=!1,$scope.x_o.forms[e]._R=!0,$scope.x_o.forms[e]._U=!1,$scope.x_o.forms[e]._D=!1;else{for(var e in $scope.x_o.forms)$scope.x_o.forms[e]._C=!1,$scope.x_o.forms[e]._R=!1,$scope.x_o.forms[e]._U=!1,$scope.x_o.forms[e]._D=!1;var o=[],s={field:"modulesID",compare:"EQUAL"};s.value=$scope.x_o.ID,o.push(s);var t={};t.params=o,t.sql="JSON_VALUE(infoJSON,'$.modulesID') = '"+$scope.x_o.ID+"'",$http.post(sloc+"KB_x_getAll?module=KB&table=accessRights&jsonFields=&orderBy=sequence&masterID=%&rowsPage=900&pageCt=1",JSON.stringify(t)).then(function(e){var o=e.data.rv;for(var s in o){var t=!0;if(""!==$scope.SelRole&&(void 0===o[s].roles||null===o[s].roles||""===o[s].roles?t=!1:o[s].roles.includes($scope.SelRole)||(t=!1)),t)for(var r in $scope.x_o.forms[$scope.xList[s].formsName]._C=o[s].create,$scope.x_o.forms[$scope.xList[s].formsName]._R=o[s].read,$scope.x_o.forms[$scope.xList[s].formsName]._U=o[s].update,$scope.x_o.forms[$scope.xList[s].formsName]._D=o[s].delete,$scope.x_o.forms)$scope.x_o.forms[r].ID===$scope.x_o.forms[$scope.xList[s].formsName].parentID&&void 0!==$scope.x_o.forms[r].parentID&&""!==$scope.x_o.forms[r].parentID&&setReadRights($scope.x_o.forms[r].name)}},function(e){return alert("error modify AccessRights "+JSON.stringify(e)),!1})}}else for(var e in $scope.x_o.forms)$scope.x_o.forms[e]._C=!0,$scope.x_o.forms[e]._R=!0,$scope.x_o.forms[e]._U=!0,$scope.x_o.forms[e]._D=!0;return!0},setReadRights=function(e){if(void 0!==e&&""!==e&&($scope.x_o.forms[e]._R=!0,void 0!==$scope.x_o.forms[e].parentID&&""!==$scope.x_o.forms[e].parentID))for(var o in $scope.x_o.forms)$scope.x_o.forms[o].ID===$scope.x_o.forms[e].parentID&&setReadRights($scope.x_o.forms[o].name)},$scope.navMain=function(e){$scope.x_form=e,void 0!==$scope.x_o.forms[$scope.x_form].rowsPage&&($scope.x_rowsPage=$scope.x_o.forms[$scope.x_form].rowsPage),$scope.x_pageCt=1,$scope.x_masterID="",$scope.x_n=[],$scope.topName="",$scope.myOrderBy=void 0,$scope.xSearchListTitle="",$scope.xSearchSql={},$scope.xSearchSql.params=[],$scope.xSearchSql.sql="",$scope.xInit()},$scope.navUp=function(e){for(var o={form:""};o.form!==e.form||""===o.form;)o=$scope.x_n.pop();retrievePrevious(o,"",""),null==$scope.x_o.forms[$scope.x_form].pages.TREE?$scope.x_page="LIST":$scope.x_page="TREE",$scope.xEditFormDirty=!1,$scope.topName="",xInitComplete()},retrievePrevious=function(e,o,s){$scope.x_masterID=e.masterID,$scope.x_form=e.form,void 0!==$scope.x_o.forms[$scope.x_form].rowsPage&&($scope.x_rowsPage=$scope.x_o.forms[$scope.x_form].rowsPage),$scope.x_pageCt=e.pageCt,$scope.x_page=e.page,$scope.xSearch=Object.assign({},e.xSearch),$scope.xSearchListTitle=e.xSearchListTitle,$scope.xSearchSql=e.xSearchSql,$scope.xElement=Object.assign({},e.xElement),""!==o&&""!==s&&($scope.xElement.infoJSON[o]=s),$scope.myOrderBy=void 0},$scope.navDown=function(e){$scope.x_n.push({form:$scope.x_form,page:$scope.x_page,masterID:$scope.x_masterID,pageCt:$scope.x_pageCt,xSearch:Object.assign({},$scope.xSearch),xSearchListTitle:$scope.xSearchListTitle,xSearchSql:$scope.xSearchSql,xElement:Object.assign({},$scope.xElement)}),$scope.topName="",$scope.x_masterID=$scope.xElement.ID,$scope.x_form=e,void 0!==$scope.x_o.forms[$scope.x_form].rowsPage&&($scope.x_rowsPage=$scope.x_o.forms[$scope.x_form].rowsPage),$scope.x_pageCt=1,$scope.myOrderBy=void 0,$scope.xSearchListTitle="",$scope.xSearchSql={},$scope.xSearchSql.params=[],$scope.xSearchSql.sql="",$scope.xInit()},$scope.navTab=function(e){$scope.x_page=e},$scope.xInitSearch=function(){$scope.xSearch={},$scope.xSearchListTitle="",$scope.xSearchSql={},$scope.xSearchSql.params=[],$scope.xSearchSql.sql="",$scope.x_page="SEARCH"},$scope.xStartSearch=function(){var e=[],o="",s="";for(var t in $scope.xSearch)if(void 0!==$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t]){var r="equal";if(void 0!==$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].comparisonType&&(r=$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].comparisonType),o.length>0&&(o+=" AND ",s+=" AND "),"date"===ca[$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].columnsID].fieldType){var c=new Date($scope.xSearch[t]);v=c.toISOString().substring(0,10),o+="LEFT(JSON_VALUE(infoJSON, '$."+ca[$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].columnsID].name+"'),10) "}else v=$scope.xSearch[t],o+="JSON_VALUE(infoJSON, '$."+ca[$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].columnsID].name+"') ";switch(s+=ca[$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].columnsID].name+" "+$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].comparisonType+" "+v,r){case"notEqual":o+="<> '"+v+"'";break;case"contains":o+="LIKE '%"+v+"%'";break;case"beginsWith":o+="LIKE '"+v+"%'";break;case"doesNotContain":o+="NOT LIKE '%"+v+"%'";break;case"greaterThan":o+="> '"+v+"'";break;case"greaterThanEqual":o+=">= '"+v+"'";break;case"lessThan":o+="< '"+v+"'";break;case"lessThanEqual":o+="<= '"+v+"'";break;case"isBlank":o+="IS NULL";break;case"isNotBlank":o+="IS NOT NULL";break;case"multiple":var n=[];if(v.length>1){for(var a in o+="IN (",v)o+="'"+v[a]+"',",n.push(v[a]);removeTrailingComma(o),o+=")",v=n;break}o+="= '"+v+"'",n[0]=v,v=n;break;default:o+="= '"+v+"'"}var p={};p.field=ca[$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].fields[t].columnsID].name,p.compare=r,p.value=v,e.push(p)}$scope.xSearchSql={},$scope.xSearchSql.params=e,$scope.xSearchSql.sql=o,$scope.xSearchListTitle=s,$scope.xInit()},$scope.xInit=function(){$scope.xEditFormDirty=!1,null==$scope.x_o.forms[$scope.x_form].pages.TREE?$scope.x_page="LIST":$scope.x_page="TREE",xInitComplete()},buildTree=function(e,o){var s,t=e+1;for(var r in s=""===o?$scope.xList.filter(function(e){return""==e.parentID}):$scope.xList.filter(function(e){return e.parentID.includes(o)})){var c={};c.ID=s[r].ID,c.parentID=s[r].parentID,c.sequence=s[r]._sequence,c.display=s[r].infoJSON.name,null==s[r].infoJSON.description?c.description="":c.description=s[r].infoJSON.description,c.level=t;var n=$scope.xList.filter(function(e){return e.parentID.includes(s[r].ID)});c.numberChildren=n.length,c.numberChildren>0?c.status="+":c.status=" ",c.level<1?c.show=!0:c.show=!1,c.position=$scope.xTree.length,$scope.xTree.push(c),c.numberChildren>0&&buildTree(t,s[r].ID)}},$scope.getStatusClass=function(e){return void 0!==e&&e.length>40?"yellow":""},xInitComplete=function(){$scope.x_n.length>0?null==$scope.x_n[$scope.x_n.length-1].xElement.name?null==$scope.x_n[$scope.x_n.length-1].xElement.date?$scope.topName="details "+$scope.x_form:$scope.topName=$scope.x_n[$scope.x_n.length-1].xElement.date+" "+$scope.x_form:$scope.topName=$scope.x_n[$scope.x_n.length-1].xElement.name+" "+$scope.x_form:$scope.topName=$scope.x_form;var e=$scope.x_masterID;if($scope.x_o.forms[$scope.x_form].masterEmpty&&(e=""),$scope.x_o.forms[$scope.x_form].ignoreMaster&&(e="%"),$scope.x_o.forms[$scope.x_form].userOnly){var o={field:"uid",compare:"="};o.value=userid,$scope.xSearchSql.params.push(o),""!==$scope.xSearchSql.sql&&($scope.xSearchSql.sql+=" AND "),$scope.xSearchSql.sql+="uid = '"+userid+"'",$scope.xSearchListTitle+=" filtered for user"}$http.post(sloc+"KB_x_getAll?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&jsonFields="+$scope.x_o.forms[$scope.x_form].fieldsJSON+"&orderBy="+$scope.x_o.forms[$scope.x_form].orderBy+"&masterID="+e+"&rowsPage="+$scope.x_rowsPage+"&pageCt="+$scope.x_pageCt,JSON.stringify($scope.xSearchSql)).then(function(e){for(var o in $scope.xList=e.data.rv,$scope.xTree=[],$scope.xList)$scope.xList[o]._sequence=o;if(buildTree(-1,""),$scope.xTotal={},void 0!==$scope.x_o.forms[$scope.x_form].fieldsTotal&&""!==$scope.x_o.forms[$scope.x_form].fieldsTotal){var s=$scope.x_o.forms[$scope.x_form].fieldsTotal.split(",");if(void 0!==s&&""!==s)for(var t in s){var r=0;for(var c in $scope.xList)void 0!==$scope.xList[c].infoJSON[s[t]]&&(r+=1*$scope.xList[c].infoJSON[s[t]]);$scope.xTotal[s[t]]=r}}$scope.xList.length>0&&$scope.x_rowsMax!==Math.round(e.data.rowCount/$scope.x_rowsPage+.5)&&($scope.x_rowsMax=Math.round(e.data.rowCount/$scope.x_rowsPage+.5))},function(e){alert("error xInit "+JSON.stringify(e)),$scope.xList=[]})},$scope.xAdd=function(e){$scope.xElement={ID:"",parentID:"",sequence:999999,infoJSON:{}},validateElement($scope.xElement.infoJSON,!1),initLookups(),setDefaults(),treeUpdate(),void 0!==$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].inlineEDIT&&$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].inlineEDIT?($scope.xList.unshift($scope.xElement),$scope.ieElement=$scope.xElement,$scope.ieeditingInProgress=!0):$scope.x_page="EDIT";var o=""+$scope.x_o.forms[$scope.x_form].fieldsMap;""!==o&&initMap(o)},$scope.xView=function(e){$scope.x_o.forms[$scope.x_form]._U?$scope.x_page="EDIT":$scope.x_page="VIEW",$scope.xElement=$scope.xList.filter(function(o){return o.ID==e.ID})[0],validateElement($scope.xElement.infoJSON,!1),initLookups(),treeUpdate();var o=""+$scope.x_o.forms[$scope.x_form].fieldsCheckbox.split(",");if(null!=o)for(var s in o)"true"===$scope.xElement.infoJSON[o[s]]&&($scope.xElement.infoJSON[o[s]]=!0);if(null!=(o=$scope.x_o.forms[$scope.x_form].fieldsDate.split(",")))for(s in o)if($scope.xElement.infoJSON[o[s]]){var t=$scope.xElement.infoJSON[o[s]].substring(0,10).split("-"),r=new Date(t[0],t[1]-1,t[2]);r.setHours(10),$scope.xElement.infoJSON[o[s]]=r}y=""+$scope.x_o.forms[$scope.x_form].fieldsMap,""!==y&&initMap(y)},$scope.xSave=function(e){if("mydata"===$scope.x_form)$http.post(sloc+"KB_x_addUpdate?module=KB&table=users&ID="+$scope.xElement.ID+"&masterID="+$scope.xElement.masterID+"&orderBy=&parentID="+$scope.xElement.parentID+"&sequence="+$scope.xElement.sequence+"&uid="+userid,JSON.stringify($scope.xElement.infoJSON)).then(function(o){$scope.xCancel(e)},function(o){alert("save error"),$scope.xCancel(e)});else if($scope.ieeditingInProgress||validateElement($scope.xElement.infoJSON,!0))if($scope.ieeditingInProgress=!1,void 0!==$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].uniqueColumns){var o=$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].uniqueColumns;if(""!==o){var s={params:[],sql:""},t=o.split(",");for(var r in t){s.sql.length>0&&(s.sql+=" AND "),"masterID"==t[r]?s.sql+="masterID = '"+$scope.xElement.masterID+"'":s.sql+="JSON_VALUE(infoJSON,'$."+t[r]+"') = '"+$scope.xElement.infoJSON[t[r]]+"'";var c={};c.field=t[r],c.compare="=",c.value=$scope.xElement.infoJSON[t[r]],s.params.push(c)}$http.post(sloc+"KB_x_getAll?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&jsonFields="+$scope.x_o.forms[$scope.x_form].fieldsJSON+"&orderBy="+$scope.x_o.forms[$scope.x_form].orderBy+"&masterID=%&rowsPage=999&pageCt=1",JSON.stringify(s)).then(function(o){var s=!1;o.data.rv.length>0?""==$scope.xElement.ID?alert("unique values required for "+$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].uniqueColumns):$scope.xElement.ID===o.data.rv[0].ID?s=!0:alert("unique values required for "+$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].uniqueColumns):s=!0,s&&xSavesuite(e)},function(e){alert("error checkUnique "+JSON.stringify(e))})}else xSavesuite(e)}else xSavesuite(e)},xSavesuite=function(e){var o=[];if(void 0!==$scope.x_o.forms[$scope.x_form].fieldsAuto&&""!==$scope.x_o.forms[$scope.x_form].fieldsAuto)o=$scope.x_o.forms[$scope.x_form].fieldsAuto.split(",");""===$scope.xElement.ID&&o.length>0?$http.post(sloc+"KB_getAuto?module="+$scope.x_o.name+"&table="+$scope.x_o.forms[$scope.x_form].tablesName,$scope.x_o.forms[$scope.x_form].fieldsAuto).then(function(s){var t=s.data.split(",");for(v in o)$scope.xElement.infoJSON[o[v]]=1*t[v]+1;$http.post(sloc+"KB_x_addUpdate?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&ID="+$scope.xElement.ID+"&masterID="+$scope.x_masterID+"&parentID="+$scope.xElement.parentID+"&orderBy="+$scope.x_o.forms[$scope.x_form].orderBy+"&sequence="+$scope.xElement.sequence+"&uid="+userid,JSON.stringify($scope.xElement.infoJSON)).then(function(o){$scope.xCancel(e)},function(e){alert("save error")})},function(e){alert("error auto "+JSON.stringify(e))}):$http.post(sloc+"KB_x_addUpdate?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&ID="+$scope.xElement.ID+"&masterID="+$scope.x_masterID+"&orderBy="+$scope.x_o.forms[$scope.x_form].orderBy+"&parentID="+$scope.xElement.parentID+"&sequence="+$scope.xElement.sequence+"&uid="+userid,JSON.stringify($scope.xElement.infoJSON)).then(function(o){$scope.xCancel(e)},function(e){alert("save error")})},$scope.xCancel=function(e){e.$setPristine(),"mydata"===$scope.x_form?($scope.x_form="",$scope.x_page="LOGIN",$scope.error="",$scope.login={usrname:"",password:"",access:""},userid="",$scope.x_n=[],$scope.topName="",$scope.x_n.length>0?null==$scope.x_n[$scope.x_n.length-1].xElement.name?$scope.topName="details "+$scope.x_form:$scope.topName=$scope.x_n[$scope.x_n.length-1].xElement.name+" "+$scope.x_form:$scope.topName=$scope.x_form,$scope.xEditFormDirty=!1):$scope.xInit()},deleteAllSublevelTables=function(e,o){for(var s in x_o.tables)x_o.tables[s].parentID.includes(o)&&xT.push(x_o.tables[s]);var t=[];for(var s in xT)$http.post(sloc+"KB_x_getAll?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+xT[s].name+"&jsonFields=&orderBy=&masterID="+e+"&rowsPage=10000&pageCt=1","").then(function(e){for(var o in t=e.data.rv)deleteAllSublevelTables(t[o].ID,xT[s].ID),$http.get(sloc+"KB_x_delete?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+xT[s].name+"&ID="+t[o].ID+"&subtable=''").then(function(e){},function(e){alert("error delete row in subtable")})},function(e){alert("error read subtable")})},$scope.xDelete=function(e){if(confirm("confirm deletion")){var o="";void 0!==$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]]&&""!==$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]]&&void 0!==$scope.x_o.forms[$scope.x_form].detachSubLevel&&$scope.x_o.forms[$scope.x_form].detachSubLevel&&(o=$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]].tablesName),$http.get(sloc+"KB_x_delete?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&ID="+$scope.xElement.ID+"&subtable="+o).then(function(s){if(""!==o)for(var t in $scope.xList)$scope.xList[t].parentID.includes($scope.xElement.ID)&&($scope.xList[t].parentID=$scope.xList[t].parentID.replace($scope.xElement.ID,""),$http.post("sloc + 'KB_x_addUpdate?module=' + defDB($scope.x_o.name, $scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db) + '&table=' + $scope.x_o.forms[$scope.x_form].tablesName + '&ID=' + $scope.xList[x].ID + '&masterID=' + $scope.xList[x].masterID + '&orderBy=' + $scope.x_o.forms[$scope.x_form].orderBy + '&parentID=' + $scope.xList[x].parentID + '&sequence=' + $scope.xList[x].sequence + '&uid=' + userid",JSON.stringify($scope.xList[t].infoJSON)).then(function(e){},function(e){alert("error removing links in children")}),deleteAllSublevelTables($scope.xElement.ID,$scope.x_o.forms[$scope.x_form].tablesID));$scope.xCancel(e)},function(o){alert("error deletion"),$scope.xCancel(e)})}},$scope.xUpDown=function(e,o,s){var t;t=null==s?e.sequence+o:s+o,$scope.myOrderBy=void 0,$http.get(sloc+"KB_x_sequencePut?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&ID="+e.ID+"&masterID="+e.masterID+"&s="+t+"&orderBy="+$scope.x_o.forms[$scope.x_form].orderBy).then(function(e){$scope.xInit()},function(e){alert("error 5")})},$scope.copyTotal=function(){var e=$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].copyTotal.split(" ");if(2===e.length){var o=e[0],s=e[1],t=$scope.xTotal[o],r=$scope.x_n.pop();$scope.topName="",retrievePrevious(r,s,t),$scope.xEditFormDirty=!0,xInitComplete()}},defDB=function(e,o){return void 0===o||""===o?e:o},$scope.spaces=function(e){for(var o="",s=0;s<=e;s++)o+="     ";return o},$scope.treeCollapse=function(){for(var e in $scope.xTree)$scope.xTree[e].numberChildren<1?$scope.xTree[e].status=" ":$scope.xTree[e].status="+",$scope.xTree[e].level>0?$scope.xTree[e].show=!1:$scope.xTree[e].show=!0},$scope.treeExpand=function(){for(var e in $scope.xTree)$scope.xTree[e].numberChildren<1?$scope.xTree[e].status=" ":$scope.xTree[e].status="-",$scope.xTree[e].show=!0},collapseChildren=function(e){var o=$scope.xTree.filter(function(o){return o.parentID.includes($scope.xTree[e].ID)});for(var s in o)$scope.xTree[o[s].position].show=!1,$scope.xTree[o[s].position].numberChildren<1?$scope.xTree[o[s].position].status=" ":$scope.xTree[o[s].position].status="+",o[s].numberChildren>0&&collapseChildren(o[s].position)},$scope.treeClick=function(e){if(" "!==$scope.xTree[e].status)if("+"===$scope.xTree[e].status){var o=$scope.xTree[e].ID,s=$scope.xTree.filter(function(e){return e.parentID.includes(o)});for(var t in s)$scope.xTree[s[t].position].show=!1,$scope.xTree[s[t].position].show=!0,$scope.xTree[s[t].position].numberChildren<1?$scope.xTree[s[t].position].status=" ":$scope.xTree[s[t].position].status="+";$scope.xTree[e].status="-"}else collapseChildren(e),$scope.xTree[e].status="+"},allowDrop=function(e){e.preventDefault()},drag=function(e){e.dataTransfer.setData("text",e.target.id)},drop=function(e){e.preventDefault();var o=e.dataTransfer.getData("text"),s=e.currentTarget.id;if(o!==s){var t=$scope.xList.filter(function(e){return e.ID===o}),r=$scope.xList.filter(function(e){return e.ID===s});if("TREE"==$scope.x_page){var c=$scope.xList[r[0]._sequence].parentID,n=$scope.xList[r[0]._sequence].sequence;$scope.xElement=$scope.xList[t[0]._sequence];o=$scope.xElement.ID;"A"==(a=prompt("A-bove\nB-elow\nC-hild - make To parent of FROM\nL-ink - make TO child of FROM\nU-link - remove FROM parent in TO","A")).toUpperCase()&&($scope.xElement.parentID=c,$scope.xElement.sequence=n-5),"B"==a.toUpperCase()&&($scope.xElement.parentID=c,$scope.xElement.sequence=n+5),"C"==a.toUpperCase()&&($scope.xElement.parentID=c,$scope.xElement.parentID.includes($scope.xList[r[0]._sequence].ID)||($scope.xElement.parentID=$scope.xList[r[0]._sequence].ID)),"L"==a.toUpperCase()&&($scope.xElement=$scope.xList[r[0]._sequence],$scope.xElement.parentID.includes(o)||($scope.xElement.parentID=$scope.xElement.parentID+" "+o,$scope.xElement.sequence=0)),"U"==a.toUpperCase()&&($scope.xElement=$scope.xList[r[0]._sequence],$scope.xElement.parentID.replace(o,""),$scope.xElement.parentID.length<40&&($scope.xElement.sequence=1)),null!==a&&$http.post(sloc+"KB_x_addUpdate?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&ID="+$scope.xElement.ID+"&masterID="+$scope.xElement.masterID+"&parentID="+$scope.xElement.parentID+"&sequence="+$scope.xElement.sequence+"&uid="+userid+"&orderBy="+$scope.x_o.forms[$scope.x_form].orderBy,JSON.stringify($scope.xElement.infoJSON)).then(function(e){$scope.xInit()},function(e){alert("drop save error")})}else{var a;"A"==(a=prompt("A-bove\nB-elow","A")).toUpperCase()&&$scope.xUpDown(t[0],-5,r[0].sequence),"B"==a.toUpperCase()&&$scope.xUpDown(t[0],5,r[0].sequence)}}},$scope.cTables=function(e,o){SearchSql={},SearchSql.params=[],SearchSql.sql="",$http.post(sloc+"KB_x_getAll?module=KB&table=tables&orderBy=sequence&masterID="+o+"&rowsPage=900&pageCt=1",JSON.stringify(SearchSql)).then(function(s){var t=s.data.rv;$http.post(sloc+"KB_x_getAll?module=KB&table=diagrams&orderBy=sequence&masterID="+o+"&rowsPage=900&pageCt=1",JSON.stringify(SearchSql)).then(function(s){var r=s.data.rv,c={},n=[];for(var a in r){var p="",l="",i="",m=t.filter(function(e){return e.name==f.infoJSON.table});if(m.length>0?(p=m[0].ID,i=m[0].name):(l=r[a].ID,i=r[a].infoJSON.table),null==c[i]||null==c[i])(u={}).oldID=p,u.newID=l,u.parentID="",u.masterID=o,c[i]=u,n.push(i);if(void 0!==r[a].parentID&&null!==r[a].parentID&&""!==r[a].parentID){var $,f=r.filter(function(e){return e.ID==r[a].parentID});if(f.length>0){var x,u,_=t.filter(function(e){return e.name==f.infoJSON.table});if(_.length>0)$=_[0].ID,x=_[0].name;else if(x=f[0].infoJSON.table,null==c[x]||null==c[x])(u={oldID:""}).newID=f[0].ID,u.parentID="",c[x]=u,n.push(x),$=f[0].ID;else $=""==c[x].oldID?c[x].newID:c[x].oldID;c[i].parentID.includes($)||x===i||(c[i].parentID+=$)}}}n.sort(),n.length>0&&confirm(n+": CREATE NEW DB TABLES")&&$http.post(sloc+"KB_ctables?module="+e,JSON.stringify(c)).then(function(e){var s="";for(var t in c){if(""!==c[t].oldID){s=c[t].oldID;break}if(""!==c[t].newID){s=c[t].newID;break}}""!==s&&$http.get(sloc+"KB_x_sequencePut?module=KB&table=tables&ID="+s+"&masterID="+o+"&s=1&orderBy=sequence").then(function(e){},function(e){console.log("resequence error")})},function(e){alert("create tables error")})},function(e){alert("error read diagrams")})},function(e){alert("read tables error")})},$scope.dbtc=function(e,o,s){if(null!=s){var t=$scope.x_o.dbs[o].name;confirm("create db table: "+t+"_"+s)&&$http.post(sloc+"KB_table?module="+t+"&table="+s,"dummy").then(function(o){$scope.xEditFormDirty=!0,$scope.xElement.infoJSON[e]=o.data},function(e){alert("db table not created")})}},$scope.dbqc=function(e,o,s,t){var r=$scope.x_o.dbs[o].name;confirm("create query for db table: "+r+"_"+t)&&$http.post(sloc+"KB_query?module="+r+"&table="+t,getFields(s)).then(function(o){$scope.xEditFormDirty=!0,$scope.xElement.infoJSON[e]=o.data},function(e){alert("db table not created")})},getFields=function(e){var o="ID __ID, masterID __masterID, parentID __parentID, sequence __sequence",s=$scope.x_o.tables[e].columns;for(var t in s){var r=s[t];"lookup"==r.fieldType&&"table"==r.source?(o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name+"') _"+$scope.x_o.columns[r].name,o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Name') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Name"):"image"==r.fieldType?(o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Path') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Path",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Width') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Width",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Height') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Height",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Capture') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Capture",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Comment') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Comment"):"utube"==r.fieldType?(o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Path') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Path",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Width') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Width",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Height') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Height"):"map"==r.fieldType?(o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Width') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Width",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Height') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Height",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Capture') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Capture",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Comment') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Comment",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Longitude') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Longitude",o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Latitude') _"+$scope.x_o.columns[r].name.substring(0,$scope.x_o.columns[r].name.length-2)+"Latitude"):o+=", JSON_VALUE(infoJSON,'$."+$scope.x_o.columns[r].name+"') _"+$scope.x_o.columns[r].name}return o},$scope.bDB=function(e,o,s){confirm("backup db to mongo and mysql: "+s)&&$http.post(sloc+"KB_bDB?module="+s+"&masterID="+o,"dummy").then(function(o){$scope.xEditFormDirty=!0,$scope.xElement.infoJSON[e]=o.data},function(e){alert("backup failure")})},buildPage=function(e,o,s,t){var r,c={};if(c.name=o,c.type=o,c.description="","LIST"==o){for(var n in c.image="",t.columns)"image"==$scope.x_o.columns[t.columns[n]].fieldType&&(c.image=$scope.x_o.columns[t.columns[n]].name);c.graph=!1,c.copyTotal=""}$htp.post(sloc+"KB_x_addUpdate?module=KB&table=pages&ID=&masterID="+e+"&parentID=&orderBy=sequence&sequence=1&uid="+userid,JSON.stringify(c)).then(function(e){r=e.data;var o={};for(var s in t.columns)o.name=$scope.x_o.columns[t.columns[s]].name,o.columnsID=t.columns[s],$htp.post(sloc+"KB_x_addUpdate?module=KB&table=forms&ID=&masterID="+r+"&parentID=&orderBy=sequence&sequence=1&uid="+userid,JSON.stringify(o)).then(function(e){},function(e){alert("field not created"+$scope.x_o.columns[t.columns[s]].name)})},function(e){alert("page not created "+o)})},buildApp=function(e,o,s,t,r){var c;for(var n in c=""===o?t.filter(function(e){return""==e.parentID}):t.filter(function(e){return e.parentID.includes(o)})){var a,p={};p.name=c[n].name,p.description=c[n].description,p.parentID=s,p.orderBy=c[n].orderBy,v_table=r.filter(function(o){return o.parentID==e&&o.name==c[n].table}),0==v_table.length&&alert("table not found "+c[n].table),p.tablesID=v_table[0].ID,p.tablesName=c[n].table,p.rowsPage=20,void 0!==c[n].detachSubLevel?p.detachSubLevel=c[n].detachSubLevel:p.detachSubLevel=!1,void 0!==c[n].filterForm?p.filterForm=c[n].filterForm:p.filterForm="",void 0!==c[n].userOnly?p.userOnly=c[n].userOnly:p.filterForm=!1,void 0!==c[n].masterEmpty?p.masterEmpty=c[n].masterEmpty:p.masterEmpty=!1,void 0!==c[n].ignoreMaster?p.ignoreMaster=c[n].ignoreMaster:p.ignoreMaster=!1,void 0!==c[n].userReservedUpdate?p.userReservedUpdate=c[n].userReservedUpdate:p.userReservedUpdate=!1,void 0!==c[n].userReservedDelete?p.userReservedDelete=c[n].userReservedDelete:p.userReservedDelete=!1,void 0!==c[n].startWithSearch?p.startWithSearch=c[n].startWithSearch:p.startWithSearch=!1,void 0!==c[n].startupForm?p.startupForm=c[n].startupForm:p.startupForm=!1,$htp.post(sloc+"KB_x_addUpdate?module=KB&table=forms&ID=&masterID="+e+"&parentID=&orderBy=sequence&sequence=1&uid="+userid,JSON.stringify(p)).then(function(o){a=o.data,c[n].createSEARCH&&buildPage(a,"SEARCH",r,v_table),buildPage(a,"LIST",r,v_table),buildPage(a,"EDIT",r,v_table),buildPage(a,"VIEW",r,v_table),buildApp(e,c[n].ID,a,t,r)},function(e){alert("form not created"+c[n].name)})}},$scope.cModule=function(e,o){if(confirm("create module from diagram: "+e)){for(var s in $scope.x_o.forms)deleteAllSublevelTables($scope.x_o.forms[s].ID,$scope.x_o.forms[s].tablesID),$http.get(sloc+"KB_x_delete?module=KB&table=forms&ID="+$scope.x_o.forms[s].ID+"&subtable=").then(function(e){},function(e){alert("error deletion: "+$scope.x_o.forms[s].name)});$http.post(sloc+"KB_x_getAll?module=KB&table=diagrams&orderBy=sequence&masterID="+o+"&rowsPage=100&pageCt=1","").then(function(e){$scope.xD=e.data.rv},function(e){alert("error read diagrams")});$http.post(sloc+"KB_x_getAll?module=KB&table=tables&orderBy=sequence&masterID="+o+"&rowsPage=100&pageCt=1","").then(function(e){$scope.xT=e.data.rv},function(e){alert("error read tables")}),builApp(o,"","",[],[])}},$scope.chart=function(){$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].graph=!1,$http.post(sloc+"KB_chart?module="+$scope.x_o.name,"dummy").then(function(e){var o=e.data,s=window.open("chart");s.document.open(""),s.document.write(o),s.document.close(),$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].graph=!0},function(e){alert("chart error"),$scope.x_o.forms[$scope.x_form].pages[$scope.x_page].graph=!0})},$scope.carousel=function(){var e={},o=$scope.x_o.forms[$scope.x_form].fieldsImage;if(void 0!==o&&""!==o)for(var s in $scope.xList){var t={};t.Picture=$scope.xList[s].infoJSON[o+"Path"],t.Description=$scope.xList[s].infoJSON[o+"Capture"],e[$scope.xList[s].ID]=t}$http.post(sloc+"KB_carousel?module="+$scope.x_o.name,JSON.stringify(e)).then(function(e){var o=e.data,s=window.open("carousel");s.document.open(""),s.document.write(o),s.document.close()},function(e){alert("carousel error")})},$scope.doc=function(e){if(""!=$scope.xElement.ID){var o={m:[],i:[],r:{},g:{}};o.xMaster=$scope.xElement.infoJSON,o.sql="",o.sqlS=[],o.sqlG=[],o.form=$scope.x_form,o.masterID=$scope.xElement.ID;var s=$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]].tablesName,t=$scope.x_o.forms[$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]].name].subForms,r="",c=$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]].orderBy.split(",");for(l in c){""!==r&&(r+=" , "),"sequence"===(m=c[l].split(":"))[0]||"name"===m[0]||"date"===m[0]?r+=" "+m[0]:r+=" JSON_VALUE(infoJSON, '$."+m[0]+"')","D"===m[1]&&(r+=" DESC ")}o.sql+="SELECT * FROM "+$scope.x_o.name+"_"+s+" WHERE masterID = '"+o.masterID+"' ORDER BY "+r+" for json path; ";var n=$scope.x_o.forms[$scope.x_form].fieldsJSON,a=$scope.x_o.forms[$scope.x_form].fieldsLookup,p=$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]].fieldsJSON;o.childTotalFields=$scope.x_o.forms[$scope.x_o.forms[$scope.x_form].subForms[0]].fieldsTotal;c=n.split(",");for(var l in c)o.m.push(c[l]);for(l in c=p.split(","))o.i.push(c[l]);if(void 0!==(c=a.split(",")))for(l in c){var i=c[l].substring(0,c[l].length-2);void 0!==$scope.xElement.infoJSON[c[l]]&&(o.sqlS.push(i),o.sql+="SELECT * FROM "+$scope.x_o.name+"_"+i+" WHERE ID = '"+$scope.xElement.infoJSON[c[l]]+"' for json path;");var m=$scope.x_o.forms[i].fieldsJSON.split(",");if(o.r[i]=[],void 0!==m)for(var $ in m)o.r[i].push(m[$]);o.r[i].sort()}if(void 0!==(c=t))for(l in c){var f=c[l],x=$scope.x_o.forms[f].tablesName;o.sqlG.push(f),o.sql+="SELECT JSON_VALUE(a.infoJSON,'$.date') date1, b.* from "+$scope.x_o.name+"_"+s+" a inner join "+$scope.x_o.name+"_"+x+" b on a.ID = b.masterID where a.masterID = '"+o.masterID+"' ORDER BY a.date for json path;";m=$scope.x_o.forms[f].fieldsJSON.split(",");if(o.g[f]=[],void 0!==m)for(var $ in m)o.g[f].push(m[$]);o.g[f].sort()}var u=[],_=a.split(","),d=p.split(",");for(var g in _)for(var v in d)_[g]===d[v]&&u.push(_[g]);var h="UPDATE "+$scope.x_o.name+"_"+s+" SET masterID = '"+o.masterID+"' WHERE masterID = '' ";for(var l in u)h+=" and JSON_VALUE(infoJSON,'$."+u[l]+"') = '"+$scope.xElement.infoJSON[u[l]]+"'";o.sql=h+";"+o.sql,o.m.sort(),o.i.sort(),$http.post(sloc+"KB_doc?module="+$scope.x_o.name,JSON.stringify(o)).then(function(o){$scope.xElement.infoJSON[e]=o.data,$http.post(sloc+"KB_x_addUpdate?module="+defDB($scope.x_o.name,$scope.x_o.tables[$scope.x_o.forms[$scope.x_form].tablesID].db)+"&table="+$scope.x_o.forms[$scope.x_form].tablesName+"&ID="+$scope.xElement.ID+"&masterID="+$scope.x_masterID+"&parentID="+$scope.xElement.parentID+"&orderBy="+$scope.x_o.forms[$scope.x_form].orderBy+"&sequence="+$scope.xElement.sequence+"&uid="+userid,JSON.stringify($scope.xElement.infoJSON)).then(function(e){},function(e){alert("save error")})},function(e){alert("doc error")})}else alert("save first !")}});